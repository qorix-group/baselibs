@startuml mw_log_recorders

' Interface
interface "mw::log::Recorder" as Recorder {
  + StartRecord(ctx:std::string_view, log_level:LogLevel) : score::cpp::optional<SlotHandle>
  + StopRecord(slot:SlotHandle&): void
  + Log(const SlotHandle&, const T data) - family of functions
  + IsLogEnabled(const LogLevel&, const std::string_view): bool
}

' Interface
interface "mw::log::detail::Backend" as Backend {
  +ReserveSlot() : score::cpp::optional<SlotHandle>
  +FlushSlot(slot : const SlotHandle&)
  +GetLogRecord(slot : const SlotHandle&): LogRecord&
}

' Recorder implementations
class "mw::log::detail::FileRecorder" as FileRecorder {
  - backend_ : std::unique_ptr<Backend>
  - config_ : Configuration
  __
  + FileRecorder(const detail::Configuration&,\n  std::unique_ptr<detail::Backend>)
  + StartRecord(ctx:std::string_view, const LogLevel): score::cpp::optional<SlotHandle>
  + StopRecord(const SlotHandle&): void
  + IsLogEnabled(const LogLevel&, const std::string_view): bool
  + Log(const SlotHandle&, T data) - family of functions
}

class "mw::log::detail::TextRecorder" as TextRecorder {
  - backend_ : std::unique_ptr<Backend>
  - config_ : Configuration
  - check_log_level_for_console_: bool
  __
  + TextRecorder(const detail::Configuration&,\n  std::unique_ptr<detail::Backend>,\n  const bool)
  + StartRecord(ctx:std::string_view, const LogLevel): score::cpp::optional<SlotHandle>
  + StopRecord(const SlotHandle&): void
  + IsLogEnabled(const LogLevel&, const std::string_view): bool
  + Log(const SlotHandle&, T data) - family of functions
}

class "mw::log::detail::DataRouterRecorder" as DataRouterRecorder {
}

class "mw::log::detail::CompositeRecorder" as CompositeRecorder {
  - recorders_ : std::vector<std::unique_ptr<Recorder>>
  __
  + CompositeRecorder(std::vector<std::unique_ptr<Recorder>> recorders)
  + StartRecord(const std::string_view, const LogLevel): score::cpp::optional<SlotHandle>
  + StopRecord(slot:SlotHandle&): void
  + GetRecorders(): std::vector<std::unique_ptr<Recorder>>&
  + IsLogEnabled(const LogLevel&, const std::string_view): bool
  + Log(const SlotHandle&, const T) - family of functions
}

class "mw::log::detail::EmptyRecorder" as EmptyRecorder {
  + StartRecord(const std::string_view, const LogLevel):\n  score::cpp::optional<SlotHandle>
  + StopRecord(const SlotHandle&): void
  + IsLogEnabled(const LogLevel&, const std::string_view): bool
  + Log(const SlotHandle&, T data) - family of functions
}

class "mw::log::detail::RecorderMock" as RecorderMock #pink {
}

' Backend implementations
class "mw::log::detail::FileOutputBackend" as FileOutputBackend {
}

class "mw::log::detail::SlogBackend" as SlogBackend {
  - app_id_: std::string
  - buffer_: CircularAllocator<mw::log::detail::LogRecord>
  - slog_buffer_: slog2_buffer_t
  - slog_buffer_config_: slog2_buffer_set_config_t
  - slog2_instance_: std::unique_ptr<score::os::qnx::Slog2>
  __
  + SlogBackend(const std::size_t,\n  const LogRecord&,\n  const std::string_view,\n  std::unique_ptr<score::os::qnx::Slog2>)
  + ReserveSlot(): score::cpp::optional<SlotHandle>
  + FlushSlot(const SlotHandle&): void
  + GetLogRecord(const SlotHandle&): LogRecord&
  __
  - Init(verbosity: std::uint8_t) : void
}

class "mw::log::detail::DataRouterBackend" as DataRouterBackend {
}

class "mw::log::detail::BackendMock" as BackendMock #pink {
}

' Helper classes
class "DltArgumentCounter" as DltArgumentCounter {
  - counter_ : std::uint8_t&
  __
  DltArgumentCounter(std::uint8_t&)
  __
  + TryAddArgument(add_argument_callback) : AddArgumentResult
}

class "mw::log::detail::TextFormat" as TextFormat {
  {static} + PutFormattedTime(VerbosePayload&) : void
  {static} + TerminateLog(VerbosePayload&) : void
  {static} + Log(VerbosePayload&, const T, const IntegerRepresentation) : void\n  - family of functions
  {static} + Log(VerbosePayload&, const T) : void\n  - family of functions
}

class "mw::log::detail::DLTFormat" as DLTFormat {
  + Log(VerbosePayload&, const bool): AddArgumentResult
  + Log(VerbosePayload&, T, const IntegerRepresentation):\n   AddArgumentResult - family of functions
}

class "mw::log::detail::CircularAllocator<T>" as CircularAllocator {
}

class "mw::log::detail::LogRecord" as LogRecord {
}

' External dependencies
class "OSAL::fcntl" as fcntl {
}

class "OSAL::Unistd" as Unistd {
}

' Relationships - Recorder interface
FileRecorder .up.|> Recorder
TextRecorder .up.|> Recorder
DataRouterRecorder .up.|> Recorder
CompositeRecorder .up.|> Recorder
EmptyRecorder .up.|> Recorder
RecorderMock .up.|> Recorder

' Relationships - Backend interface
FileOutputBackend .up.|> Backend
SlogBackend .up.|> Backend
DataRouterBackend .up.|> Backend
BackendMock .up.|> Backend

' Composition relationships
FileRecorder *-- Backend
FileRecorder *-- DltArgumentCounter
TextRecorder *-- Backend
TextRecorder *-- DltArgumentCounter
DataRouterRecorder *-- Backend

' Dependencies
FileRecorder ..> TextFormat : Log
FileRecorder ..> DLTFormat : uses
TextRecorder ..> TextFormat : Log
DataRouterRecorder ..> DLTFormat : uses
TextRecorder ..> DLTFormat : uses

' Backend composition
SlogBackend *-- CircularAllocator
SlogBackend --> LogRecord : uses

' External dependencies
FileRecorder ..> fcntl : open\nSetNonBlocking / fctrl call
FileRecorder ..> Unistd : close

' Notes
note bottom of Recorder
  Refer Recorder.h for all the Log(const SlotHandle&, const T data)
  - family of functions
end note

note top of TextFormat
  Refer text_format.h for all the Log(...)
  - family of functions
end note

@enduml
